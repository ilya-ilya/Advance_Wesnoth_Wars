#textdomain aww
### 9. LEVEL-UP AMLA RANDOM BONUSES
# Author: Ruvaak, Toranks
# Original Creation
# tests: unit advances=9
# weird : the assignation of new trait in pre advance/avance event make a infinite loop. so splitted in 2 events.
# 1 event  + see event aww_00_trigger_pre_advance_common
# 1 unit variable used : aww_pre_advances_to
# will imply stat increases or new/updated abilities / weapon specials

# This event check if a unit just advanced at his last type, to give the new Bonus advancements for the next level, his first AMLA. And repeat every advancement to rebuild the Bonus list with the new stats. Only applies to humans, because the AI doesn't know how to choose AMLAs.
[event]
    name=post advance
    id=aww_09_trigger_amla_bonus_asignation_advance
    first_time_only=no
    [filter_condition]
        {AWW_NOT_ISSET_VARIABLE unit.advances_to}
        [or]
            {VARIABLE_CONDITIONAL unit.advances_to equals ""}
        [/or]
        [and]
            {AWW_ENABLED_FEATURE_09_MANUAL}
        [/and]
    [/filter_condition]
    [if]
        [lua]
            code = <<
			local ec = wesnoth.current.event_context
			local result = wesnoth.sync.evaluate_single(
				function()
					return { value = true }
				end,
				function()
					-- Called only on the client handling the current side, if it is an AI.
					return { value = false }
				end,
				wesnoth.units.get(ec.unit_x, ec.unit_y).side
				)
				return result.value
			>>
        [/lua]
        [then]
            [fire_event]
                name=aww_09_apply_trait
                [primary_unit]
                    x,y=$x1,$y1
                [/primary_unit]
            [/fire_event]

            [fire_event]
                name=aww_09_bonus_asignation
                [primary_unit]
                    x,y=$x1,$y1
                [/primary_unit]
            [/fire_event]

            [unit_overlay]
                {AWW_FILTER_CAN_BE_PROMOTED}
                x,y=$x1,$y1
                [not]
                    [filter_wml]
                        [variables]
                            aww_amla_icon=yes
                        [/variables]
                    [/filter_wml]
                [/not]
                image=misc/aww-leader-bonus-bronze.png
            [/unit_overlay]
            [modify_unit]
                [filter]
                    {AWW_FILTER_CAN_BE_PROMOTED}
                    x,y=$x1,$y1
                [/filter]
                [variables]
                    aww_amla_icon=yes
                [/variables]
            [/modify_unit]
        [/then]
    [/if]
[/event]

[event]
    name=unit placed
    id=aww_09_trigger_amla_bonus_asignation_placed
    first_time_only=no
    [filter_condition]
        {AWW_NOT_ISSET_VARIABLE unit.advances_to}
        [or]
            {VARIABLE_CONDITIONAL unit.advances_to equals ""}
        [/or]
        [and]
            {AWW_ENABLED_FEATURE_09_MANUAL}
        [/and]
    [/filter_condition]
    [filter]
        [not]
            [filter_wml]
                [variables]
                    aww_amla_manual=yes
                [/variables]
            [/filter_wml]
        [/not]
    [/filter]
    [if]
        [lua]
            code = <<
			local ec = wesnoth.current.event_context
			local result = wesnoth.sync.evaluate_single(
				function()
					return { value = true }
				end,
				function()
					-- Called only on the client handling the current side, if it is an AI.
					return { value = false }
				end,
				wesnoth.units.get(ec.unit_x, ec.unit_y).side
				)
				return result.value
		>>
        [/lua]
        [then]
            [fire_event]
                name=aww_09_bonus_asignation
                [primary_unit]
                    x,y=$x1,$y1
                [/primary_unit]
            [/fire_event]

            [unit_overlay]
                {AWW_FILTER_CAN_BE_PROMOTED}
                x,y=$x1,$y1
                [not]
                    [filter_wml]
                        [variables]
                            aww_amla_icon=yes
                        [/variables]
                    [/filter_wml]
                [/not]
                image=misc/aww-leader-bonus-bronze.png
            [/unit_overlay]
            [modify_unit]
                [filter]
                    {AWW_FILTER_CAN_BE_PROMOTED}
                    x,y=$x1,$y1
                [/filter]
                [variables]
                    aww_amla_icon=yes
                [/variables]
            [/modify_unit]
        [/then]
    [/if]
[/event]

# triggers random bonus and applies icon

#ifndef NON_FATAL_WOUNDS_EXTENDED
[event]
    name=post_advance
    id=aww_09_trigger_post_advance_amla_extra_bonus
    first_time_only=no
    [filter_condition]
        {AWW_TEST_WAS_AMLA}
        {AWW_ENABLED_FEATURE_09}
    [/filter_condition]
    [fire_event]
        name=aww_09_bonus_selection
        [primary_unit]
            x,y=$x1,$y1
        [/primary_unit]
    [/fire_event]
    [unit_overlay]
        {AWW_FILTER_CAN_BE_PROMOTED}
        x,y=$x1,$y1
        [not]
            [filter_wml]
                [variables]
                    aww_amla_icon=yes
                [/variables]
            [/filter_wml]
        [/not]
        image=misc/aww-leader-bonus-bronze.png
    [/unit_overlay]
    [modify_unit]
        [filter]
            {AWW_FILTER_CAN_BE_PROMOTED}
            x,y=$x1,$y1
        [/filter]
        [variables]
            aww_amla_icon=yes
        [/variables]
    [/modify_unit]
[/event]
#endif

# triggers random bonus and applies icon for IA when human have Manual Bonuses
[event]
    name=post_advance
    id=aww_09_trigger_post_advance_amla_extra_bonus_ia
    first_time_only=no
    [filter_condition]
        {AWW_TEST_WAS_AMLA}
        {AWW_ENABLED_FEATURE_09_MANUAL}
    [/filter_condition]

    [if]
        [lua]
            code = <<
			local ec = wesnoth.current.event_context
			local result = wesnoth.sync.evaluate_single(
				function()
					return { value = false }
				end,
				function()
					-- Called only on the client handling the current side, if it is an AI.
					return { value = true }
				end,
				wesnoth.units.get(ec.unit_x, ec.unit_y).side
				)
				return result.value
		>>
        [/lua]
        [then]
            [fire_event]
                name=aww_09_bonus_selection
                [primary_unit]
                    x,y=$x1,$y1
                [/primary_unit]
            [/fire_event]
            [unit_overlay]
                {AWW_FILTER_CAN_BE_PROMOTED}
                x,y=$x1,$y1
                [not]
                    [filter_wml]
                        [variables]
                            aww_amla_icon=yes
                        [/variables]
                    [/filter_wml]
                [/not]
                image=misc/aww-leader-bonus-bronze.png
            [/unit_overlay]
            [modify_unit]
                [filter]
                    {AWW_FILTER_CAN_BE_PROMOTED}
                    x,y=$x1,$y1
                [/filter]
                [variables]
                    aww_amla_icon=yes
                [/variables]
            [/modify_unit]
        [/then]
    [/if]
[/event]

# bonus applied randomly
[event]
    name=aww_09_bonus_selection
    first_time_only=no

    {VARIABLE_OP rand_bonus rand(1..25)}

    [switch]
        variable=rand_bonus

        ## Max melee/ranged damage/hits :
        [case]
            value=1,12
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        range=melee
                        formula="number > 2"
                    [/has_attack]
                [/have_unit]
                [then]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        [object]
                            id=aww_amla_melee_damage_object
                            take_only_once=no
                            duration=forever
                            [effect]
                                apply_to=attack
                                range=melee
                                increase_damage=3
                            [/effect]
                        [/object]
                    [/modify_unit]
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"melee"+": "+_"damage"+" +3" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        message= _ "Melee damage"+" +3"
                    [/message]
                [/then]
                [else]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/else]
            [/if]
        [/case]
        [case]
            value=2,11
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        range=ranged
                        formula="number > 2"
                    [/has_attack]
                [/have_unit]
                [then]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        [object]
                            id=aww_amla_ranged_damage_object
                            take_only_once=no
                            duration=forever
                            [effect]
                                apply_to=attack
                                range=ranged
                                increase_damage=2
                            [/effect]
                        [/object]
                    [/modify_unit]
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"ranged"+": "+_"damage"+" +2" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        message= _ "Ranged damage"+" +2"
                    [/message]
                [/then]
                [else]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/else]
            [/if]
        [/case]

        [case]
            value=3,25
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        range=melee
                        formula="number < 4"
                    [/has_attack]
                [/have_unit]
                [then]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        [object]
                            id=aww_amla_melee_strike_object
                            take_only_once=no
                            duration=forever
                            [effect]
                                apply_to=attack
                                range=melee
                                increase_attacks=1
                            [/effect]
                        [/object]
                    [/modify_unit]
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"melee"+": "+_"strikes"+" +1" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        message= _ "Melee strikes"+" +1"
                    [/message]
                [/then]
                [else]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/else]
            [/if]
        [/case]
        [case]
            value=4,14
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        range=ranged
                        formula="number < 4"
                    [/has_attack]
                [/have_unit]
                [then]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        [object]
                            id=aww_amla_ranged_strike_object
                            take_only_once=no
                            duration=forever
                            [effect]
                                apply_to=attack
                                range=ranged
                                increase_attacks=1
                            [/effect]
                        [/object]
                    [/modify_unit]
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"ranged"+": "+_"strikes"+" +1" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        message= _ "Ranged strikes"+" +1"
                    [/message]
                [/then]
                [else]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/else]
            [/if]
        [/case]

        # Max Moves +1 :

        [case]
            value=5,15
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_movement_points_object
                    take_only_once=no
                    duration=forever
                    [effect]
                        apply_to=movement
                        increase=1
                    [/effect]
                [/object]
            [/modify_unit]
            {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"Moves"+" +1" {AWW_COLOR_AMLA}}
            [message]
                speaker=unit
                message= _ "Movement points"+" +1"
            [/message]
        [/case]

        ## New Abilities (only one by id, previous always keeped) :

        [case]
            value=6
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    ability_type=leadership
                [/have_unit]
                [or]
                    [have_unit]
                        x,y=$x1,$y1
                        level=0,1,2
                    [/have_unit]
                [/or]
                [or]
                    {AWW_ENABLED_FEATURE_15}
                    [and]
                        [have_unit]
                            x,y=$x1,$y1
                            level=0,1,2,3,4
                        [/have_unit]
                    [/and]
                [/or]
                [then]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/then]
                [else]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        [object]
                            id=aww_amla_leadership_object
                            duration=forever
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    {AWW_AMLA_LEADERSHIP_CAPPED $aww_leadership_level}
                                [/abilities]
                            [/effect]
                        [/object]
                        [set_variable]
                            name=aww_amla_has_leadership
                            value=yes
                        [/set_variable]
                    [/modify_unit]
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"Leadership" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        message= _ "Leadership"
                    [/message]
                [/else]
            [/if]
        [/case]
        [case]
            value=7
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    ability=distract,aww_distract
                [/have_unit]
                [or]
                    [have_unit]
                        x,y=$x1,$y1
                        [filter_wml]
                            [modifications]
                                [object]
                                    id=aww_amla_distract_object
                                [/object]
                            [/modifications]
                        [/filter_wml]
                    [/have_unit]
                [/or]
                [then]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/then]
                [else]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        [object]
                            id=aww_amla_distract_object
                            duration=forever
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    {AWW_ABILITY_DISTRACT}
                                [/abilities]
                            [/effect]
                        [/object]
                    [/modify_unit]
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"Distract" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        message= _ "Distract"
                    [/message]
                [/else]
            [/if]
        [/case]
        [case]
            value=17
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    ability_type=regenerate
                [/have_unit]
                [then]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/then]
                [else]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        [object]
                            id=aww_amla_regen_object
                            duration=forever
                            {AWW_ABILITY_EFFECT_CUSTOM_REGEN 4}
                        [/object]
                    [/modify_unit]
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"Regenerates" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        message= _ "Regenerates"
                    [/message]
                [/else]
            [/if]
        [/case]

        ## Weapons Specials (need to delete previous one before adding it - or detect if already existing, but slower process) :

        [case]
            value=8
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        special_type=firststrike
                    [/has_attack]
                [/have_unit]
                [or]
                    [have_unit]
                        x,y=$x1,$y1
                        [has_attack]
                            formula="number > 3"
                        [/has_attack]
                    [/have_unit]
                    [and]
                        [not]
                            [have_unit]
                                x,y=$x1,$y1
                                [has_attack]
                                    formula="number = 1"
                                [/has_attack]
                            [/have_unit]
                        [/not]
                    [/and]
                [/or]
                [or]
                    [not]
                        [have_unit]
                            x,y=$x1,$y1
                            [has_attack]
                                formula="number < 3"
                            [/has_attack]
                        [/have_unit]
                    [/not]
                [/or]
                [then]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/then]
                [else]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        [object]
                            id=aww_amla_firststrike_object
                            duration=forever
                            [effect]
                                apply_to=attack
                                [set_specials]
                                    mode=append
                                    #textdomain wesnoth-help
                                    [firststrike]
                                        id=firststrike
                                        name= "<i>"+_"first strike"+"</i>"
                                        description= _ "This unit always strikes first with this attack, even if they are defending."
                                        special_note={INTERNAL:SPECIAL_NOTES_FIRSTSTRIKE}
                                    [/firststrike]
                                [/set_specials]
                            [/effect]
                        [/object]
                        #textdomain aww
                    [/modify_unit]
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"Firststrike" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        message= _ "Firststrike"
                    [/message]
                [/else]
            [/if]
        [/case]
        [case]
            value=9
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        special_type=poison
                    [/has_attack]
                [/have_unit]
                [or]
                    [have_unit]
                        x,y=$x1,$y1
                        [has_attack]
                            special_type=damage
                        [/has_attack]
                    [/have_unit]
                [/or]
                [or]
                    [not]
                        [have_unit]
                            x,y=$x1,$y1
                            [has_attack]
                                type=pierce,blade
                            [/has_attack]
                        [/have_unit]
                    [/not]
                [/or]
                [then]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/then]
                [else]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        [object]
                            id=aww_amla_poison_object
                            duration=forever
                            [effect]
                                apply_to=attack
                                type=pierce,blade
                                [set_specials]
                                    mode=append
                                    #textdomain wesnoth-help
                                    [poison]
                                        id=poison
                                        name= _ "<i>"+_"poison"+"</i>"
                                        description= _ "This attack poisons living targets. Poisoned units lose 8 HP every turn until they are cured or are reduced to 1 HP. Poison cannot, of itself, kill a unit."
                                        special_note={INTERNAL:SPECIAL_NOTES_POISON}
                                    [/poison]
                                [/set_specials]
                            [/effect]
                        [/object]
                        #textdomain aww
                    [/modify_unit]
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"Poison" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        message= _ "Poisonous bladed or pierced weapons"
                    [/message]
                [/else]
            [/if]
        [/case]
        [case]
            value=16
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        special_type=drains
                    [/has_attack]
                [/have_unit]
                [or]
                    [have_unit]
                        x,y=$x1,$y1
                        [has_attack]
                            special_type=heal_on_hit
                        [/has_attack]
                    [/have_unit]
                [/or]
                [or]
                    [not]
                        [have_unit]
                            x,y=$x1,$y1
                            [has_attack]
                                range=melee
                                formula="number > 3"
                            [/has_attack]
                        [/have_unit]
                    [/not]
                [/or]
                [then]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/then]
                [else]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        [object]
                            id=aww_amla_adrenaline_object
                            duration=forever
                            {AWW_ATTACK_EFFECT_ADRENALINE}
                        [/object]
                    [/modify_unit]
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"Adrenaline" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        message= _ "Adrenaline"+" +4"
                    [/message]
                [/else]
            [/if]
        [/case]
        [case]
            value=10
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    upkeep=loyal
                [/have_unit]
                [or]
                    [have_unit]
                        x,y=$x1,$y1
                        canrecruit=yes
                    [/have_unit]
                [/or]
                [or]
                    [have_unit]
                        x,y=$x1,$y1
                        level=0,1,2
                    [/have_unit]
                [/or]
                [then]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/then]
                [else]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        #textdomain wesnoth-help
                        [trait]
                            id=aww_amla_loyal
                            male_name= "<i>"+_"loyal"+"</i>"
                            female_name= "<i>"+_"female^loyal"+"</i>"
                            description= _ "Zero upkeep"
                            help_text= _ "<italic>text='Loyal'</italic> units don’t incur upkeep. Most units incur an upkeep cost at the end of every turn, which is equal to their level. Loyal units do not incur this cost."
                            [effect]
                                apply_to=loyal
                            [/effect]
                            [effect]
                                apply_to=overlay
                                add="misc/loyal-icon.png"
                            [/effect]
                        [/trait]
                    [/modify_unit]
                    #textdomain wesnoth-lib
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"Loyal" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        male_message= _ "Loyal"
                        female_message= _ "female^Loyal"
                    [/message]
                [/else]
            [/if]
        [/case]
        [case]
            value=13
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    trait=fearless
                [/have_unit]
                [or]
                    [have_unit]
                        x,y=$x1,$y1
                        trait=aww_amla_fearless
                    [/have_unit]
                [/or]
                [or]
                    [have_unit]
                        x,y=$x1,$y1
                        formula="alignment = neutral"
                    [/have_unit]
                [/or]
                [or]
                    [have_unit]
                        x,y=$x1,$y1
                        ability_type=illuminates
                    [/have_unit]
                [/or]
                [then]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/then]
                [else]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        #textdomain wesnoth-help
                        [trait]
                            id=aww_amla_fearless
                            male_name= "<i>"+_"fearless"+"</i>"
                            female_name= "<i>"+_"female^fearless"+"</i>"
                            description= _ "Fights normally during unfavorable times of day/night"
                            help_text= _ "Aversion to light and dark holds no sway over these brave individuals."
                            [effect]
                                apply_to="fearless"
                            [/effect]
                        [/trait]
                    [/modify_unit]
                    #textdomain aww
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"Fearless" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        male_message= _ "Fearless"
                        female_message= _ "female^Fearless"
                    [/message]
                [/else]
            [/if]
        [/case]
        [case]
            value=24
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        special_type=damage
                    [/has_attack]
                [/have_unit]
                [or]
                    [not]
                        [have_unit]
                            x,y=$x1,$y1
                            [has_attack]
                                range=melee
                                type=blade,pierce
                            [/has_attack]
                        [/have_unit]
                    [/not]
                [/or]
                [then]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/then]
                [else]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        [object]
                            id=aww_amla_backstab_object
                            duration=forever
                            [effect]
                                apply_to=attack
                                range=melee
                                type=blade,pierce
                                [set_specials]
                                    mode=append
                                    ## important to append to cumulate with charge and others specials
                                    [damage]
                                        id=backstab
                                        #textdomain wesnoth-help
                                        name="<i>"+_"backstab"+"</i>"
                                        #textdomain aww
                                        description= _ "When used offensively, this attack deals 50% more damage if there is an enemy of the target on the opposite side of the target, and that unit is not incapacitated (turned to stone or otherwise paralyzed)."
                                        special_note={INTERNAL:SPECIAL_NOTES_BACKSTAB}
                                        multiply=1.5
                                        active_on=offense
                                        [filter_opponent]
                                            formula="
												enemy_of(self, flanker) and not flanker.petrified
											where
												flanker = unit_at(direction_from(loc, other.facing))
											"
                                        [/filter_opponent]
                                    [/damage]
                                [/set_specials]
                            [/effect]
                        [/object]
                    [/modify_unit]
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"Backstab" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        message= _ "Melee backstab on blade or pierce weapons"
                    [/message]
                [/else]
            [/if]
        [/case]
        [case]
            value=20,22
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        special_type=chance_to_hit
                    [/has_attack]
                [/have_unit]
                [or]
                    [not]
                        [have_unit]
                            x,y=$x1,$y1
                            [has_attack]
                                range=ranged
                            [/has_attack]
                        [/have_unit]
                    [/not]
                [/or]
                [then]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/then]
                [else]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        [object]
                            id=aww_amla_marksman_object
                            duration=forever
                            [effect]
                                apply_to=attack
                                range=ranged
                                #textdomain wesnoth-help
                                [set_specials]
                                    mode=append
                                    [chance_to_hit]
                                        id=marksman
                                        name= "<i>"+_"marksman"+"</i>"
                                        description= _ "When used offensively, this attack always has at least a 60% chance to hit."
                                        special_note={INTERNAL:SPECIAL_NOTES_MARKSMAN}
                                        value=60
                                        cumulative=yes
                                        active_on=offense
                                    [/chance_to_hit]
                                [/set_specials]
                            [/effect]
                        [/object]
                        #textdomain aww
                    [/modify_unit]
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"Marksman" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        message= _ "Minimum accuracy of 60% for ranged weapons"
                    [/message]
                [/else]
            [/if]
        [/case]
        [case]
            value=23,19
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        type=cold
                    [/has_attack]
                [/have_unit]
                [and]
                    [not]
                        [have_unit]
                            x,y=$x1,$y1
                            [has_attack]
                                special_type=slow
                            [/has_attack]
                        [/have_unit]
                    [/not]
                [/and]
                [then]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        [object]
                            id=aww_amla_slows_object
                            duration=forever
                            [effect]
                                apply_to=attack
                                type=cold
                                #textdomain wesnoth-help
                                [set_specials]
                                    mode=append
                                    [slow]
                                        id=slow
                                        name= "<i>"+_"slows"+"</i>"
                                        description= _ "This attack slows the target until it ends a turn. Slow halves the damage caused by attacks and the movement cost for a slowed unit is doubled. A unit that is slowed will feature a snail icon in its sidebar information when it is selected."
                                        special_note={INTERNAL:SPECIAL_NOTES_SLOW}
                                    [/slow]
                                [/set_specials]
                            [/effect]
                        [/object]
                        #textdomain aww
                    [/modify_unit]
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"Slows" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        message= _ "Slows on cold type attacks"
                    [/message]
                [/then]
                [else]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/else]
            [/if]
        [/case]
        [case]
            value=18,21
            [if]
                [have_unit]
                    x,y=$x1,$y1
                    ability_type=hides
                [/have_unit]
                [or]
                    [have_unit]
                        x,y=$x1,$y1
                        trait=ghost_trait
                    [/have_unit]
                [/or]
                [or]
                    {VARIABLE_CONDITIONAL aww_unit_type.movement_type equals undeadspirit}
                [/or]
                [and]
                    [not]
                        [have_unit]
                            x,y=$x1,$y1
                            ability=aww_ability_camouflage
                        [/have_unit]
                    [/not]
                [/and]
                [then]
                    [modify_unit]
                        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                        [object]
                            id=aww_amla_camouflage_object
                            duration=forever
                            [effect]
                                apply_to=remove_ability
                                [abilities]
                                    {ABILITY_AMBUSH}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=remove_ability
                                [abilities]
                                    {ABILITY_CONCEALMENT}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=remove_ability
                                [abilities]
                                    {ABILITY_SUBMERGE}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=remove_ability
                                [abilities]
                                    {ABILITY_NIGHTSTALK}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    {AWW_ABILITY_CAMOUFLAGE}
                                [/abilities]
                            [/effect]
                        [/object]
                    [/modify_unit]
                    {AWW_FLOAT_TEXT_SCROLL $x1 $y1 _"Camouflage" {AWW_COLOR_AMLA}}
                    [message]
                        speaker=unit
                        message= _ "Camouflage"
                    [/message]
                [/then]
                [else]
                    [fire_event]
                        name=aww_09_bonus_selection
                        [primary_unit]
                            x,y=$x1,$y1
                        [/primary_unit]
                    [/fire_event]
                [/else]
            [/if]
        [/case]
    [/switch]
    {CLEAR_VARIABLE rand_bonus}
[/event]

[event]
    name=aww_09_bonus_asignation
    first_time_only=no
    [modify_unit]
        [filter]
            x,y=$x1,$y1
        [/filter]
        [effect]
            apply_to=remove_advancement
            amla=aww_amla_movement_points_advancement,aww_amla_camouflage_advancement,aww_amla_slows_advancement,aww_amla_marksman_advancement,aww_amla_backstab_advancement,aww_amla_fearless_advancement,aww_amla_loyal_advancement,aww_amla_adrenaline_advancement,aww_amla_poison_advancement,aww_amla_firststrike_advancement,aww_amla_regen_advancement,aww_amla_distract_advancement,aww_amla_leadership_advancement,aww_amla_ranged_strike_advancement,aww_amla_ranged_strike_advancement_double,aww_amla_melee_strike_advancement,aww_amla_melee_strike_advancement_double,aww_amla_ranged_damage_advancement,aww_amla_melee_damage_advancement
        [/effect]
    [/modify_unit]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_movement_points_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_camouflage_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_slows_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_marksman_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_backstab_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_fearless_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_loyal_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_adrenaline_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_poison_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_firststrike_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_regen_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_distract_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_leadership_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_melee_strike_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_ranged_strike_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_ranged_damage_object_advancement
    [/remove_object]
    [remove_object]
        x,y=$x1,$y1
        object_id=aww_amla_melee_damage_object_advancement
    [/remove_object]
    [store_unit_type]
        type=$unit.type
        variable=aww_unit_type
    [/store_unit_type]
    [if]
        [have_unit]
            x,y=$x1,$y1
            [has_attack]
                range=melee
                formula="number > 2"
            [/has_attack]
        [/have_unit]
        [then]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_melee_damage_object_advancement
                    take_only_once=no
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        [advancement]
                            id=aww_amla_melee_damage_advancement
                            description=_ "Melee damage +3"+_", Max XP +$aww_09_bonus_exp_percentage%"
                            max_times=3
                            image="attacks/battleaxe.png"
                            [effect]
                                apply_to=attack
                                range=melee
                                increase_damage=3
                            [/effect]
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/then]
    [/if]
    [if]
        [have_unit]
            x,y=$x1,$y1
            [has_attack]
                range=ranged
                formula="number > 2"
            [/has_attack]
        [/have_unit]
        [then]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_ranged_damage_object_advancement
                    take_only_once=no
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        [advancement]
                            id=aww_amla_ranged_damage_advancement
                            description=_ "Ranged damage +2"+_", Max XP +$aww_09_bonus_exp_percentage%"
                            max_times=3
                            image="attacks/bow-short-reinforced.png"
                            [effect]
                                apply_to=attack
                                range=ranged
                                increase_damage=2
                            [/effect]
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/then]
    [/if]
    [if]
        [have_unit]
            x,y=$x1,$y1
            [has_attack]
                range=melee
                formula="number < 4"
            [/has_attack]
            [not]
                [has_attack]
                    range=melee
                    number=1
                [/has_attack]
                [or]
                    [filter_wml]
                        [modifications]
                            [advancement]
                                id=aww_amla_melee_strike_advancement_double
                            [/advancement]
                        [/modifications]
                    [/filter_wml]
                [/or]
            [/not]
        [/have_unit]
        [then]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_melee_strike_object_advancement
                    take_only_once=no
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        [advancement]
                            id=aww_amla_melee_strike_advancement
                            description=_ "Melee strikes +1"+_", Max XP +$aww_09_bonus_exp_percentage%"
                            max_times=-1
                            image="icons/crossed_sword_and_hammer.png"
                            [effect]
                                apply_to=attack
                                range=melee
                                increase_attacks=1
                            [/effect]
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/then]
        [elseif]
            [have_unit]
                x,y=$x1,$y1
                [has_attack]
                    range=melee
                    formula="number < 3"
                [/has_attack]
            [/have_unit]
            [then]
                [modify_unit]
                    {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                    [object]
                        id=aww_amla_melee_strike_object_advancement
                        take_only_once=no
                        duration=forever
                        [effect]
                            apply_to=new_advancement
                            [advancement]
                                id=aww_amla_melee_strike_advancement_double
                                description=_ "Melee strikes +1"+_", Max XP +$($aww_09_bonus_exp_percentage * 2)%"
                                max_times=-1
                                image="icons/crossed_sword_and_hammer.png"
                                [effect]
                                    apply_to=attack
                                    range=melee
                                    increase_attacks=1
                                [/effect]
                                [effect]
                                    apply_to=hitpoints
                                    heal_full=yes
                                [/effect]
                                [effect]
                                    apply_to=max_experience
                                    increase=$($aww_09_bonus_exp_percentage * 2)%
                                [/effect]
                                [effect]
                                    apply_to=status
                                    remove=poisoned
                                [/effect]
                                [effect]
                                    apply_to=status
                                    remove=slowed
                                [/effect]
                            [/advancement]
                        [/effect]
                    [/object]
                [/modify_unit]
            [/then]
        [/elseif]
    [/if]
    [if]
        [have_unit]
            x,y=$x1,$y1
            [has_attack]
                range=ranged
                formula="number < 4"
            [/has_attack]
            [not]
                [has_attack]
                    range=ranged
                    number=1
                [/has_attack]
                [or]
                    [filter_wml]
                        [modifications]
                            [advancement]
                                id=aww_amla_ranged_strike_advancement_double
                            [/advancement]
                        [/modifications]
                    [/filter_wml]
                [/or]
            [/not]
        [/have_unit]
        [then]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_ranged_strike_object_advancement
                    take_only_once=no
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        [advancement]
                            id=aww_amla_ranged_strike_advancement
                            description=_ "Ranged strikes +1"+_", Max XP +$aww_09_bonus_exp_percentage%"
                            max_times=-1
                            image="attacks/bow-elven.png"
                            [effect]
                                apply_to=attack
                                range=ranged
                                increase_attacks=1
                            [/effect]
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/then]
        [elseif]
            [have_unit]
                x,y=$x1,$y1
                [has_attack]
                    range=ranged
                    formula="number < 3"
                [/has_attack]
            [/have_unit]
            [then]
                [modify_unit]
                    {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                    [object]
                        id=aww_amla_ranged_strike_object_advancement
                        take_only_once=no
                        duration=forever
                        [effect]
                            apply_to=new_advancement
                            [advancement]
                                id=aww_amla_ranged_strike_advancement_double
                                description=_ "Ranged strikes +1"+_", Max XP +$($aww_09_bonus_exp_percentage * 2)%"
                                max_times=-1
                                image="attacks/bow-elven.png"
                                [effect]
                                    apply_to=attack
                                    range=ranged
                                    increase_attacks=1
                                [/effect]
                                [effect]
                                    apply_to=hitpoints
                                    heal_full=yes
                                [/effect]
                                [effect]
                                    apply_to=max_experience
                                    increase=$($aww_09_bonus_exp_percentage * 2)%
                                [/effect]
                                [effect]
                                    apply_to=status
                                    remove=poisoned
                                [/effect]
                                [effect]
                                    apply_to=status
                                    remove=slowed
                                [/effect]
                            [/advancement]
                        [/effect]
                    [/object]
                [/modify_unit]
            [/then]
        [/elseif]
    [/if]
    [if]
        [have_unit]
            x,y=$x1,$y1
            ability_type=leadership
        [/have_unit]
        [or]
            [have_unit]
                x,y=$x1,$y1
                level=0,1,2
            [/have_unit]
        [/or]
        [or]
            {AWW_ENABLED_FEATURE_15}
            [and]
                [have_unit]
                    x,y=$x1,$y1
                    level=0,1,2,3,4
                [/have_unit]
            [/and]
        [/or]
        [else]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_leadership_object_advancement
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        [advancement]
                            id=aww_amla_leadership_advancement
                            description=_ "Leadership"+_", Max XP +$aww_09_bonus_exp_percentage%"
                            image="misc/leader.png"
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    {AWW_AMLA_LEADERSHIP_CAPPED $aww_leadership_level}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/else]
    [/if]
    [if]
        [have_unit]
            x,y=$x1,$y1
            ability=distract,aww_distract
        [/have_unit]
        [else]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_distract_object_advancement
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        [advancement]
                            id=aww_amla_distract_advancement
                            description=_ "Distract"+_", Max XP +$aww_09_bonus_exp_percentage%"
                            image="attacks/gaze.png"
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    {AWW_ABILITY_DISTRACT}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/else]
    [/if]
    [if]
        [have_unit]
            x,y=$x1,$y1
            ability_type=regenerate
        [/have_unit]
        [else]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_regen_object_advancement
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        [advancement]
                            id=aww_amla_regen_advancement
                            description=_ "Regenerates"+_", Max XP +$aww_09_bonus_exp_percentage%"
                            image="misc/meditation-icon.png"
                            {AWW_ABILITY_EFFECT_CUSTOM_REGEN 4}
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/else]
    [/if]
    [if]
        [have_unit]
            x,y=$x1,$y1
            [has_attack]
                special_type=firststrike
            [/has_attack]
        [/have_unit]
        [or]
            [have_unit]
                x,y=$x1,$y1
                [has_attack]
                    formula="number > 3"
                [/has_attack]
            [/have_unit]
            [and]
                [not]
                    [have_unit]
                        x,y=$x1,$y1
                        [has_attack]
                            formula="number = 1"
                        [/has_attack]
                    [/have_unit]
                [/not]
            [/and]
        [/or]
        [or]
            [not]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        formula="number < 3"
                    [/has_attack]
                [/have_unit]
            [/not]
        [/or]
        [else]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_firststrike_object_advancement
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        [advancement]
                            id=aww_amla_firststrike_advancement
                            description=_ "Firststrike"+_", Max XP +$aww_09_bonus_exp_percentage%"
                            image="attacks/spear-simple.png"
                            [effect]
                                apply_to=attack
                                [set_specials]
                                    mode=append
                                    #textdomain wesnoth-help
                                    [firststrike]
                                        id=firststrike
                                        name= "<i>"+_"first strike"+"</i>"
                                        description= _ "This unit always strikes first with this attack, even if they are defending."
                                        special_note={INTERNAL:SPECIAL_NOTES_FIRSTSTRIKE}
                                    [/firststrike]
                                [/set_specials]
                            [/effect]
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/else]
    [/if]
    #textdomain aww
    [if]
        [have_unit]
            x,y=$x1,$y1
            [has_attack]
                special_type=poison
            [/has_attack]
        [/have_unit]
        [or]
            [have_unit]
                x,y=$x1,$y1
                [has_attack]
                    special_type=damage
                [/has_attack]
            [/have_unit]
        [/or]
        [or]
            [not]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        type=pierce,blade
                    [/has_attack]
                [/have_unit]
            [/not]
        [/or]
        [else]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_poison_object_advancement
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        [advancement]
                            id=aww_amla_poison_advancement
                            description=_ "Poisonous bladed or pierced weapons"+_", Max XP +$aww_09_bonus_exp_percentage%"
                            image="attacks/dagger-thrown-poison-human.png"
                            [effect]
                                apply_to=attack
                                type=pierce,blade
                                [set_specials]
                                    mode=append
                                    #textdomain wesnoth-help
                                    [poison]
                                        id=poison
                                        name= _ "<i>"+_"poison"+"</i>"
                                        description= _ "This attack poisons living targets. Poisoned units lose 8 HP every turn until they are cured or are reduced to 1 HP. Poison cannot, of itself, kill a unit."
                                        special_note={INTERNAL:SPECIAL_NOTES_POISON}
                                    [/poison]
                                [/set_specials]
                            [/effect]
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/else]
    [/if]
    #textdomain aww
    [if]
        [have_unit]
            x,y=$x1,$y1
            [has_attack]
                special_type=drains
            [/has_attack]
        [/have_unit]
        [or]
            [have_unit]
                x,y=$x1,$y1
                [has_attack]
                    special_type=heal_on_hit
                [/has_attack]
            [/have_unit]
        [/or]
        [or]
            [not]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        range=melee
                        formula="number > 3"
                    [/has_attack]
                [/have_unit]
            [/not]
        [/or]
        [else]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_adrenaline_object_advancement
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        [advancement]
                            id=aww_amla_adrenaline_advancement
                            description=_ "Adrenaline"+" +4"+_", Max XP +$aww_09_bonus_exp_percentage%"
                            image="attacks/frenzy.png"
                            {AWW_ATTACK_EFFECT_ADRENALINE}
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/else]
    [/if]
    [if]
        [have_unit]
            x,y=$x1,$y1
            upkeep=loyal
        [/have_unit]
        [or]
            [have_unit]
                x,y=$x1,$y1
                canrecruit=yes
            [/have_unit]
        [/or]
        [or]
            [have_unit]
                x,y=$x1,$y1
                level=0,1,2
            [/have_unit]
        [/or]
        [or]
            {AWW_ENABLED_FEATURE_15}
            [and]
                [have_unit]
                    x,y=$x1,$y1
                    level=0,1,2,3,4
                [/have_unit]
            [/and]
        [/or]
        [else]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_loyal_object_advancement
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        #textdomain wesnoth-lib
                        [advancement]
                            id=aww_amla_loyal_advancement
                            description=_ "Loyal"+_", Max XP +$($aww_09_bonus_exp_percentage * 2)%"
                            image="icons/ring_gold.png"
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                            [effect]
                                apply_to=status
                                add=amla_loyal
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/else]
    [/if]
    #textdomain aww
    [if]
        [have_unit]
            x,y=$x1,$y1
            trait=fearless
        [/have_unit]
        [or]
            [have_unit]
                x,y=$x1,$y1
                trait=aww_amla_fearless
            [/have_unit]
        [/or]
        [or]
            [have_unit]
                x,y=$x1,$y1
                formula="alignment = neutral"
            [/have_unit]
        [/or]
        [or]
            [have_unit]
                x,y=$x1,$y1
                ability_type=illuminates
            [/have_unit]
        [/or]
        [else]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_fearless_object_advancement
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        [advancement]
                            id=aww_amla_fearless_advancement
                            description=_ "Fearless"+_", Max XP +$aww_09_bonus_exp_percentage%"
                            image="misc/fearless.png"
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                            [effect]
                                apply_to=status
                                add=amla_fearless
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/else]
    [/if]
    #textdomain aww
    [if]
        [have_unit]
            x,y=$x1,$y1
            [has_attack]
                special_type=damage
            [/has_attack]
        [/have_unit]
        [or]
            [not]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        range=melee
                        type=blade,pierce
                    [/has_attack]
                [/have_unit]
            [/not]
        [/or]
        [else]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_backstab_object_advancement
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        [advancement]
                            id=aww_amla_backstab_advancement
                            description=_ "Melee backstab on blade or pierce weapons"+_", Max XP +$aww_09_bonus_exp_percentage%"
                            image="attacks/dagger-curved.png"
                            [effect]
                                apply_to=attack
                                range=melee
                                type=blade,pierce
                                [set_specials]
                                    mode=append
                                    ## important to append to cumulate with charge and others specials
                                    [damage]
                                        id=backstab
                                        #textdomain wesnoth-help
                                        name="<i>"+_"backstab"+"</i>"
                                        #textdomain aww
                                        description= _ "When used offensively, this attack deals 50% more damage if there is an enemy of the target on the opposite side of the target, and that unit is not incapacitated (turned to stone or otherwise paralyzed)."
                                        special_note={INTERNAL:SPECIAL_NOTES_BACKSTAB}
                                        multiply=1.5
                                        active_on=offense
                                        [filter_opponent]
                                            formula="
												enemy_of(self, flanker) and not flanker.petrified
											where
												flanker = unit_at(direction_from(loc, other.facing))
											"
                                        [/filter_opponent]
                                    [/damage]
                                [/set_specials]
                            [/effect]
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/else]
    [/if]
    [if]
        [have_unit]
            x,y=$x1,$y1
            [has_attack]
                special_type=chance_to_hit
            [/has_attack]
        [/have_unit]
        [or]
            [not]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        range=ranged
                    [/has_attack]
                [/have_unit]
            [/not]
        [/or]
        [else]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_marksman_object_advancement
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        [advancement]
                            id=aww_amla_marksman_advancement
                            description=_ "Minimum accuracy of 60% for ranged weapons"+_", Max XP +$aww_09_bonus_exp_percentage%"
                            image="attacks/blowgun.png"
                            [effect]
                                apply_to=attack
                                range=ranged
                                #textdomain wesnoth-help
                                [set_specials]
                                    mode=append
                                    [chance_to_hit]
                                        id=marksman
                                        name= "<i>"+_"marksman"+"</i>"
                                        description= _ "When used offensively, this attack always has at least a 60% chance to hit."
                                        special_note={INTERNAL:SPECIAL_NOTES_MARKSMAN}
                                        value=60
                                        cumulative=yes
                                        active_on=offense
                                    [/chance_to_hit]
                                [/set_specials]
                            [/effect]
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/else]
    [/if]
    [if]
        [have_unit]
            x,y=$x1,$y1
            [has_attack]
                special_type=slow
            [/has_attack]
        [/have_unit]
        [or]
            [not]
                [have_unit]
                    x,y=$x1,$y1
                    [has_attack]
                        type=cold
                    [/has_attack]
                [/have_unit]
            [/not]
        [/or]
        #textdomain aww
        [else]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_slows_object_advancement
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        [advancement]
                            id=aww_amla_slows_advancement
                            description=_ "Slows on cold type attacks"+_", Max XP +$aww_09_bonus_exp_percentage%"
                            image="attacks/waterspray.png"
                            [effect]
                                apply_to=attack
                                type=cold
                                #textdomain wesnoth-help
                                [set_specials]
                                    mode=append
                                    [slow]
                                        id=slow
                                        name= "<i>"+_"slows"+"</i>"
                                        description= _ "This attack slows the target until it ends a turn. Slow halves the damage caused by attacks and the movement cost for a slowed unit is doubled. A unit that is slowed will feature a snail icon in its sidebar information when it is selected."
                                        special_note={INTERNAL:SPECIAL_NOTES_SLOW}
                                    [/slow]
                                [/set_specials]
                            [/effect]
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/else]
    [/if]
    #textdomain aww
    [if]
        [have_unit]
            x,y=$x1,$y1
            ability_type=hides
        [/have_unit]
        [or]
            [have_unit]
                x,y=$x1,$y1
                trait=ghost_trait
            [/have_unit]
        [/or]
        [or]
            {VARIABLE_CONDITIONAL aww_unit_type.movement_type equals undeadspirit}
        [/or]
        [and]
            [not]
                [have_unit]
                    x,y=$x1,$y1
                    ability=aww_ability_camouflage
                [/have_unit]
            [/not]
        [/and]
        [then]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                [object]
                    id=aww_amla_camouflage_object_advancement
                    duration=forever
                    [effect]
                        apply_to=new_advancement
                        [advancement]
                            id=aww_amla_camouflage_advancement
                            description=_ "Camouflage"+_", Max XP +$aww_09_bonus_exp_percentage%"
                            image="attacks/beak.png"
                            [effect]
                                apply_to=remove_ability
                                [abilities]
                                    {ABILITY_AMBUSH}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=remove_ability
                                [abilities]
                                    {ABILITY_CONCEALMENT}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=remove_ability
                                [abilities]
                                    {ABILITY_SUBMERGE}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=remove_ability
                                [abilities]
                                    {ABILITY_NIGHTSTALK}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    {AWW_ABILITY_CAMOUFLAGE}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=hitpoints
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=max_experience
                                increase=$aww_09_bonus_exp_percentage%
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=poisoned
                            [/effect]
                            [effect]
                                apply_to=status
                                remove=slowed
                            [/effect]
                        [/advancement]
                    [/effect]
                [/object]
            [/modify_unit]
        [/then]
    [/if]
    [modify_unit]
        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
        [object]
            id=aww_amla_movement_points_object_advancement
            take_only_once=no
            duration=forever
            [effect]
                apply_to=new_advancement
                [advancement]
                    id=aww_amla_movement_points_advancement
                    description=_ "Movement points"+" +1"+_", Max XP +$aww_09_bonus_exp_percentage%"
                    image="icons/boots_elven.png"
                    max_times=3
                    [effect]
                        apply_to=movement
                        increase=1
                    [/effect]
                    [effect]
                        apply_to=hitpoints
                        heal_full=yes
                    [/effect]
                    [effect]
                        apply_to=max_experience
                        increase=$aww_09_bonus_exp_percentage%
                    [/effect]
                    [effect]
                        apply_to=status
                        remove=poisoned
                    [/effect]
                    [effect]
                        apply_to=status
                        remove=slowed
                    [/effect]
                [/advancement]
            [/effect]
        [/object]
    [/modify_unit]
    [modify_unit]
        {AWW_EMBEDDED_FILTER_EVENT_UNIT}
        [variables]
            aww_amla_manual=yes
        [/variables]
    [/modify_unit]
[/event]

# apply advancement traits checking the status, because traits can't be applied as advancement iself
[event]
    name=aww_09_apply_trait
    id=aww_09_apply_trait_advancements
    first_time_only=no

    [if]
        [have_unit]
            x,y=$x1,$y1
            status=amla_fearless
        [/have_unit]
        [not]
            [have_unit]
                x,y=$x1,$y1
                trait=aww_amla_fearless
            [/have_unit]
        [/not]
        [then]
            [modify_unit]
                {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                #textdomain wesnoth-help
                [trait]
                    id=aww_amla_fearless
                    male_name= "<i>"+_"fearless"+"</i>"
                    female_name= "<i>"+_"female^fearless"+"</i>"
                    description= _ "Fights normally during unfavorable times of day/night"
                    help_text= _ "Aversion to light and dark holds no sway over these brave individuals."
                    [effect]
                        apply_to="fearless"
                    [/effect]
                [/trait]
            [/modify_unit]
        [/then]
        [elseif]
            [have_unit]
                x,y=$x1,$y1
                status=amla_loyal
            [/have_unit]
            [not]
                [have_unit]
                    x,y=$x1,$y1
                    trait=aww_amla_loyal
                [/have_unit]
            [/not]
            [then]
                [modify_unit]
                    {AWW_EMBEDDED_FILTER_EVENT_UNIT}
                    [trait]
                        id=aww_amla_loyal
                        male_name= "<i>"+_"loyal"+"</i>"
                        female_name= "<i>"+_"female^loyal"+"</i>"
                        description= _ "Zero upkeep"
                        help_text= _ "<italic>text='Loyal'</italic> units don’t incur upkeep. Most units incur an upkeep cost at the end of every turn, which is equal to their level. Loyal units do not incur this cost."
                        [effect]
                            apply_to=loyal
                        [/effect]
                        [effect]
                            apply_to=overlay
                            add="misc/loyal-icon.png"
                        [/effect]
                    [/trait]
                [/modify_unit]
            [/then]
        [/elseif]
    [/if]
[/event]

#textdomain aww
## To disable earned abilities :
[event]
    name=aww_event_09_disable
    id=aww_09_trigger_disable
    first_time_only=no

    [modify_unit]
        [filter]
            [filter_wml]
                [variables]
                    aww_amla_has_leadership=yes
                [/variables]
            [/filter_wml]
        [/filter]
        [set_variable]
            name=aww_amla_has_leadership
            value=no
        [/set_variable]
    [/modify_unit]

    [modify_unit]
        [filter]
            [filter_wml]
                [variables]
                    aww_amla_manual=yes
                [/variables]
            [/filter_wml]
        [/filter]
        [set_variable]
            name=aww_amla_manual
            value=no
        [/set_variable]
    [/modify_unit]

    {REMOVE_ALL_BONUS_ADVANCEMENTS}

    [aww_remove_object]
        object_id=aww_amla_leadership_object,aww_amla_distract_object,aww_amla_regen_object,aww_amla_firststrike_object,aww_amla_poison_object,aww_amla_adrenaline_object,aww_amla_melee_damage_object,aww_amla_ranged_damage_object,aww_amla_melee_strike_object,aww_amla_ranged_strike_object,aww_amla_movement_points_object,aww_amla_backstab_object,aww_amla_marksman_object,aww_amla_slows_object,aww_amla_camouflage_object,aww_amla_icon_overlay
    [/aww_remove_object]

    [aww_remove_trait]
        trait_id=aww_amla_loyal
    [/aww_remove_trait]
    [aww_remove_trait]
        trait_id=aww_amla_fearless
    [/aww_remove_trait]

    [store_unit]
        [filter]
        [/filter]
        variable=all_units
    [/store_unit]

    [for]
        array=all_units
        variable=n
        [do]
            [for]
                array=all_units[$n].modifications.advancement
                variable=m
                [do]
                    [if]
                        {VARIABLE_CONDITIONAL all_units[$n].modifications.advancement[$m].id contains aww_amla}
                        [then]
                            {CLEAR_VARIABLE all_units[$n].modifications.advancement[$m]}
                        [/then]
                    [/if]
                    [while]
                        {VARIABLE_CONDITIONAL aww_not_more_advancements not_equals yes}
                        [do]
                            [if]
                                {VARIABLE_CONDITIONAL all_units[$n].modifications.advancement[$m].id contains aww_amla}
                                [then]
                                    {CLEAR_VARIABLE all_units[$n].modifications.advancement[$m]}
                                [/then]
                                [else]
                                    {VARIABLE aww_not_more_advancements yes}
                                [/else]
                            [/if]
                        [/do]
                    [/while]
                    {CLEAR_VARIABLE aww_not_more_advancements}
                [/do]
            [/for]
            [unstore_unit]
                variable=all_units[$n]
            [/unstore_unit]
            [transform_unit]
                id=$all_units[$n].id
                transform_to=$all_units[$n].type
            [/transform_unit]
        [/do]
    [/for]

    [remove_unit_overlay]
        image=misc/aww-leader-bonus-bronze.png
    [/remove_unit_overlay]
[/event]

[event]
    name=aww_event_09_rebuild
    id=aww_09_trigger_rebuild
    first_time_only=no

    {REMOVE_ALL_BONUS_ADVANCEMENTS}

    [store_unit]
        [filter]
            [filter_wml]
                [variables]
                    aww_amla_manual=yes
                [/variables]
            [/filter_wml]
        [/filter]
        kill=no
        variable=units_with_amla
    [/store_unit]

    [foreach]
        variable=amla_unit
        array=units_with_amla
        [do]
            [fire_event]
                name=aww_09_bonus_asignation
                [primary_unit]
                    id=$amla_unit.id
                [/primary_unit]
            [/fire_event]
        [/do]
    [/foreach]
[/event]

## To change method from advancement to random :
[event]
    name=aww_event_09_change
    id=aww_09_trigger_change
    first_time_only=no

    {REMOVE_ALL_BONUS_ADVANCEMENTS}
[/event]

# give advancements to a unit under special conditions. For example, when the unit belongs to an AI side and changes to human in the middle of a scenario.
[event]
    name=start,aww_09_create_give_menu
    id=aww_event_09_give_menu
    [filter_condition]
        {VARIABLE_CONDITIONAL aww_09_enable_amla_menu equals yes}
    [/filter_condition]
    [set_menu_item]
        id=aww_give_advancements
        description=_"Give manual advancements"
        synced=yes
        image=misc/aww-bonus-menu.png
        [show_if]
            [have_unit]
                x,y=$x1,$y1
            [/have_unit]
            {AWW_ENABLED_FEATURE_09_MANUAL}
            [and]
                {AWW_NOT_ISSET_VARIABLE unit.advances_to}
                [or]
                    {VARIABLE_CONDITIONAL unit.advances_to equals ""}
                [/or]
            [/and]
        [/show_if]
        [command]
            [fire_event]
                name=aww_09_bonus_asignation
                [primary_unit]
                    x,y=$x1,$y1
                [/primary_unit]
            [/fire_event]
        [/command]
    [/set_menu_item]
[/event]
